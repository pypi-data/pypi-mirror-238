<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BioImage.IO Chatbot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Add the Font Awesome library -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"
    integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous" />
  <link rel="icon" type="image/x-icon" href="https://bioimage.io/static/icons/favicon.ico">
  <style>
    /* Custom CSS */
    .markdown-body {
      max-width: calc(100% - 40px);
    }
    .rounded-icon-container {
        margin-left:2px;
        margin-right:2px;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #ddd;  /* or any color you prefer */
    }
  
    /* Styles for the message container */
    #chat1 .message-container {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 10px;
    }

    #chat1 .message-container.user-message {
      flex-direction: row-reverse;
    }

    #chat1 .message-container i {
      font-size: 20px;
      margin-right: 10px;
    }

    #chat1 .message-container.robot-message i {
      margin-right: 0;
      margin-left: 10px;
    }

    #chat1 .message-container .message-content {
      background-color: #f2f2f2;
      padding: 14px;
      border-radius: 10px;
      max-width: 90%;
      word-break: break-word;
    }

    #chat1 .message-container.user-message .message-content {
      background-color: #dff9fb;
    }

    #chat1 .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    #chat1 textarea {
      height: 20px;
      resize: none;
      overflow: hidden;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>


<body>
  <div class="container mt-5">
    <div class="card" id="chat1">
      <div class="card-header">
        <img src="https://bioimage.io/static/img/bioimage-io-icon.svg" alt="BioImage.IO Icon"
          style="height: 24px; margin-right: 10px">
        BioImage.IO Chatbot
      </div>

      <div class="card-body">
        <div class="message-holder"></div>
        <div class="form-outline">
          <label class="form-label" for="textAreaExample" id="status-text">Type your message and press enter</label>
          <textarea class="form-control message" id="textAreaExample"></textarea>
        </div>
        <button type="button" class="btn btn-primary mt-3 send-btn"><i class="fas fa-paper-plane"></i>Send</button>

        <!-- Add an "Edit Profile" button to toggle the profile options -->
        <button type="button" class="btn btn-info mt-3" id="edit-profile-btn">
          <i class="fas fa-pen"></i>Edit Profile
        </button>
        <!-- Add a "Reset" button to restart the session -->
        <button type="button" class="btn btn-secondary mt-3" id="reset-btn">
          <i class="fas fa-sync-alt"></i>Reset
        </button>

        <!-- Profile options initially collapsed -->
        <div id="profileOptions" class="collapse">
          <input type="text" class="form-control mt-3" id="userNameInput" placeholder="Enter your name...">
          <input type="text" class="form-control mt-3" id="userOccupationInput" placeholder="Enter your occupation...">
          <input type="text" class="form-control mt-3" id="userBackgroundInput" placeholder="Enter your background...">
          <!-- Add a "Save" button for the user profile -->
          <button type="button" class="btn btn-success mt-3" id="save-profile-btn">
            Save
          </button>
        </div>

        <!-- Add the "Channels" dropdown menu -->
        <div class="form-outline btn-info mt-3">
          <label for="channelSelect">Knowledge Base Channel: </label>
          <select class="form-select" id="channelSelect">
            <option value="" disabled selected>Select a Channel</option>
          </select>
        </div>

      </div>
    </div>
    <div class="card-footer text-center">
      <!-- Helper message for personalized answers -->
      <p class="mt-3">Tips: Customize your profile to get personalized answers based on your background.</p>
      <a href="https://ai4life.eurobioimaging.eu/" target="_blank"><img src="https://ai4life.eurobioimaging.eu/wp-content/uploads/2022/09/AI4Life-logo_giraffe-nodes-2048x946.png"
        alt="AI4Life Icon" style="height: 80px; margin-right: 10px">
      </a>
      <br>
      <a href="https://github.com/bioimage-io/bioimageio-chatbot/blob/main/docs/DISCLAIMER.md" target="_blank">Disclaimer for BioImage.IO Chatbot</a> 
      <br>
      <a href="https://github.com/bioimage-io/bioimageio-chatbot/" target="_blank" style="text-decoration: none; color: inherit;">
        <span class="badge bg-secondary"><i class="fab fa-github" style="font-size: 12px;"></i>Github</span>
      </a>  
      <span class="badge bg-secondary">bioimageio-chatbot v0.1.0</span>
      <br>
          
      <a href="https://badge.fury.io/py/bioimageio-chatbot" target="_blank"><img src="https://badge.fury.io/py/bioimageio-chatbot.svg" alt="PyPI version" height="18"></a>
    </div>
  </div>



  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/imjoy-rpc@0.5.6/dist/hypha-rpc-websocket.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.1.3/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

  <script>
    $(document).ready(async function () {
      let svc;
      const spinner = `<div class="spinner"></div>`; // Spinner HTML
      const shortIntroMessage = "Hi there! I'm Melman, your community knowledge base assistant for bioimage analysis. How can I assist you today?";
      // Manually toggle the collapse for profile options
      $('#edit-profile-btn').click(function () {
        $('#profileOptions').collapse('toggle');
      });

      async function initializeService(){
        $('.message-holder').append(spinner);
        showConnectingStatus();
        try {
          // get service_id from query string
          const urlParams = new URLSearchParams(window.location.search);
          const service_id = urlParams.get('service_id');
          const server_url = urlParams.get('server_url');
          const server = await hyphaWebsocketClient.connectToServer({
            "server_url": server_url || "https://ai.imjoy.io"
          })
          const svc = await server.getService(service_id || "bioimageio-chatbot")
          showReadyStatus();
          appendRobotMessage(shortIntroMessage); // Append robot message to the message container
          return svc;
        }
        catch (e) {
          // If connection fails, show an error message in the status
          showErrorStatus('Failed to connect to the server');
          alert("Failed to get BioImage.IO Chatbot service")
        }
        finally {
          $('.spinner').remove();
        }
      }
      // Reset the chat session and clear chat history
      function resetChat() {
        chat_history.length = 0; // Clear the chat history
        code = ''; // Reset code
        error_message = ''; // Reset error message
        $('.message-holder').empty(); // Clear the messages
        initializeService();
      }

      $('#reset-btn').click(function () {
        resetChat(); // Call the reset function when the "Reset" button is clicked
      });

      // Load user profile from local storage
      const savedUserProfile = JSON.parse(localStorage.getItem('userProfile'));
      if (savedUserProfile) {
        $('#userNameInput').val(savedUserProfile.name);
        $('#userOccupationInput').val(savedUserProfile.occupation);
        $('#userBackgroundInput').val(savedUserProfile.background);
      }

      // Save button click event to save the user profile to local storage
      $('#save-profile-btn').click(function () {
        const userName = $('#userNameInput').val();
        const userOccupation = $('#userOccupationInput').val();
        const userBackground = $('#userBackgroundInput').val();

        // Create a user_profile object with name, occupation, and background
        const user_profile = {
          name: userName,
          occupation: userOccupation,
          background: userBackground
        };

        // Save the user profile to local storage
        localStorage.setItem('userProfile', JSON.stringify(user_profile));

        // Collapse the profile options after saving
        $('#profileOptions').collapse('hide');
      });
      var code;
      var error_message;
      // Add this event listener to automatically resize the textarea based on its content
      var textarea = document.getElementById('textAreaExample');
      textarea.addEventListener('input', autoResize, false);
      autoResize.call(textarea);

      var renderer = new marked.Renderer();
      marked.setOptions({
        gfm: true,
        tables: true,
        breaks: true,
        pedantic: false,
        smartLists: true,
        smartypants: false
      });

      renderer.link = function( href, title, text ) {
        return '<a target="_blank" href="'+ href +'" title="' + title + '">' + text + '</a>';
      }

      function autoResize() {
        this.style.height = (this.scrollHeight) + 'px';
      }
      svc = await initializeService();
      const channels = svc.channels;
      const channelSelect = document.getElementById('channelSelect');

      // Clear any existing options
      channelSelect.innerHTML = '<option value="" disabled selected>Select a Channel</option>';

      channels.forEach((channel) => {
        const option = document.createElement('option');
        option.value = channel;
        option.textContent = channel;
        channelSelect.appendChild(option);
      });
      // add 'auto' channel
      const option = document.createElement('option');
      option.value = 'auto';
      option.textContent = 'auto';
      channelSelect.appendChild(option);
      channelSelect.value = 'auto';
  
      const chat_history = [];

      async function sendMessage(e) {
        e.preventDefault();
        const message = $('.message').val();
        const userName = $('#userNameInput').val();
        const userOccupation = $('#userOccupationInput').val();
        const userBackground = $('#userBackgroundInput').val();
        const selectedChannel = $('#channelSelect').val(); // Get the selected channel
        // Create a user_profile object with name, occupation, and background
        let user_profile = {
          name: userName,
          occupation: userOccupation,
          background: userBackground
        };

        $('.message').val('').focus();

        appendUserMessage(message); // Append user message to the message container
        // Show 'Thinking...' status while waiting for the server's response
        showThinkingStatus();
        $('.message-holder').append(`
        <div id="progress-message-container" class="message-container robot-message">
          <div class="rounded-icon-container">
            <i class="fas fa-robot" style="margin-left: 0px;margin-top: -2px;"></i>
          </div>
          
          <div  class="markdown-body message-content">
            <h3><div class="spinner" style='display: inline-block;width:25px;height:25px;margin-bottom:-4px;'></div>🤔Thinking...</h3>
            <div id="progress-message-content">
            </div>
          </div>
        </div>`);
        let accumulatedArgs = ""
        function statusCallback(message){
          if(message.type === 'function_call'){
            if(message.status === 'in_progress'){
              accumulatedArgs += message.arguments
            }
            else{
              accumulatedArgs = message.arguments
            }
            content = // `<details> <summary>${message.name}</summary>`+
              "**Generating response for " + message.name + "...**" +
              "\n" + accumulatedArgs.replace(/\\n/g, '\n') + "\n\n";
              // + "</details>";
            $('#progress-message-content').html(marked(content, { renderer:renderer }));
          }
        }
        try{
          response = await svc.chat(message, chat_history, user_profile, selectedChannel, statusCallback);
          console.log(response)
          chat_history.push({ role: 'user', content: message })
          chat_history.push({ role: 'assistant', content: response })
          showReadyStatus();
        }
        catch(e){
          // generate an error message to simulate how Melman from Madagascar would respond to an error
          response = "Oh no! I'm sorry, I don't know how to answer that. I'm just a giraffe after all. Please try again.";
          showErrorStatus(`The server failed to respond, please try again.`);
          console.error(e);
        }
        finally{
          // Remove spinner and set status back to 'Ready to chat' after finishing
          $('.spinner').remove();
          $('#progress-message-container').remove();
          appendRobotMessage(response); // Append robot message to the message container
        } 
      }

      function appendUserMessage(message) {
        let messageContainer = `<div class="message-container user-message">
                                  <div class="rounded-icon-container">
                                   <i class="fas fa-user" style="margin-left: 10px;margin-bottom: 3px;"></i>
                                  </div>
                                   <div class="message-content">${message}</div>
                                </div>`;
        $('.message-holder').append(messageContainer);
      }

      /* function appendRobotMessage(message) {
        let messageContainer = `<div class="message-container robot-message">
                                   <i class="fas fa-robot"></i>
                                   <div class="message-content">${message}</div>
                                </div>`;
        $('.message-holder').append(messageContainer);
      } */
      function appendRobotMessage(message) {
        // Convert the message to HTML using the marked library
        const htmlMessage = marked(message, { renderer:renderer });

        let messageContainer = `<div class="message-container robot-message">
          <div class="rounded-icon-container">
            <img style="width: 20px;" src="https://bioimage.io/static/img/bioimage-io-icon.svg" alt="Melman the Giraffe" width="30" height="30">
          </div>
          <div class="message-content markdown-body">${htmlMessage}</div>
        </div>`;

        $('.message-holder').append(messageContainer);
      }
      // Function to update the status text
      function updateStatus(status) {
        $('#status-text').text(status);
      }
      // Function to show the status as 'Connecting to server...'
      function showConnectingStatus() {
        updateStatus('Connecting to server...');
      }
      // Function to show the status as 'Thinking...'
      function showThinkingStatus() {
        updateStatus('...');
      }

      // Function to show the status as 'Ready to chat'
      function showReadyStatus() {
        updateStatus('Ready to chat! Type your message and press enter!');
      }

      // Function to show the error message in the status
      function showErrorStatus(errorMessage) {
        updateStatus('Error: ' + errorMessage);
      }

      $("#textAreaExample").on("keydown", function (event) {
        if (event.key === "Enter") {
          event.preventDefault(); // Prevent the default new line behavior
          if (event.shiftKey) {
            textarea.value += "\n"; // Add a new line when Shift is held
          } else {
            sendMessage(event); // Send the message when Enter is pressed
          }
        }
      });

      $('.send-btn').on('click', sendMessage);
    });
  </script>
  <!-- https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.3.0/github-markdown.min.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.3.0/github-markdown-light.css" />
</body>

</html>