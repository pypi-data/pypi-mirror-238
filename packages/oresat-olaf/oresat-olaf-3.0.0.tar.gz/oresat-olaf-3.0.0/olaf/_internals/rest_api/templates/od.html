{% extends "base.html" %}

{% block content %}
  <style>
    table {
      font-family: arial, sans-serif;
      border-collapse: collapse;
      margin-left: auto;
      margin-right: auto;
    }
    td, th {
      border: 1px solid #dddddd;
      text-align: left;
      padding: 8px;
    }
    #variableObj, #arrayRecordObj {
      display: none;
    }
    label, .boldText {
      font-weight: bold;
    }
  </style>
  <label for="indexSelect">Index:</label>
  <select id="indexSelect"></select>
  <label for="subindexSelect">Subindex:</label>
  <select id="subindexSelect"></select>
  <br/>
  <br/>
  <div id="variableObj">
    <table>
      <tr>
        <td>Object Type</td>
        <td>VARIABLE</td>
      </tr>
      <tr>
        <td>Name</td>
        <td><span id="varName"></span></td>
      </tr>
      <tr>
        <td>Description</td>
        <td><pre id="varDesc"></pre></td>
      </tr>
      <tr>
        <td>Data Type</td>
        <td><span id="varDataType"></span></td>
      </tr>
      <tr>
        <td>Access Type *</td>
        <td><span id="varAccessType"></span></td>
      </tr>
      <tr>
        <td>Value</td>
        <td><span id="varValue"></span></td>
      </tr>
    </table>
    <br/>
    <label for="objNewValue">New Value:</label>
    <input type="text" id="objNewValue" name="objNewValue"/>
    <button id="setObjectValueButton" onclick="setObjectValue()">Change</button>
    <br/>
    <br/>
    <small>* Access premissions are be bypassed by REST API for testing/integration purposes. They are inforce over the CAN bus.</small>
  </div>
  <div id="arrayRecordObj">
    <table>
      <tr>
        <td>Object Type</td>
        <td><span id="objType"></span></td>
      </tr>
      <tr>
        <td>Name</td>
        <td><span id="objName"></span></td>
      </tr>
      <tr>
        <td>Description</td>
        <td><pre id="objDesc"></pre></td>
      </tr>
      <tr>
        <td>Subindexes</td>
        <td><span id="objSubindexes"></span></td>
      </tr>
    </table>
  </div>
  <script>
    async function updateData() {
      const index = document.getElementById("indexSelect").value;
      const subindex = document.getElementById("subindexSelect").value;

      if (index === "") {
        alert("error: requires at least the index field to be set")
        return;
      }

      const obj = await readValue(index, subindex);

      if (obj.error !== undefined) {
        document.getElementById("variableObj").style.display = "none";
        document.getElementById("arrayRecordObj").style.display = "none";

        alert(`error: ${obj.error}`);
      } else if (obj["object_type"] === "VARIABLE") {
        document.getElementById("variableObj").style.display = "inline";
        document.getElementById("arrayRecordObj").style.display = "none";

        document.getElementById("varName").textContent = obj.name;
        document.getElementById("varDesc").textContent = obj.description;
        document.getElementById("varDataType").textContent = obj.data_type;
        document.getElementById("varAccessType").textContent = obj.access_type;
        document.getElementById("varValue").textContent = obj.value;
        document.getElementById("objNewValue").value = obj.value;
      } else {
        document.getElementById("variableObj").style.display = "none";
        document.getElementById("arrayRecordObj").style.display = "inline";

        document.getElementById("objType").textContent = obj.object_type;
        document.getElementById("objName").textContent = obj.name;
        document.getElementById("objDesc").textContent = obj.description;
        document.getElementById("objSubindexes").textContent = Object.keys(obj.subindexes).length;
      }
    }

    async function setObjectValue() {
      const indexSelect = document.getElementById("indexSelect");
      const subindexSelect = document.getElementById("subindexSelect");
      const value = document.getElementById("objNewValue").value;
      const index = parseInt(indexSelect.value, 16);
      let subindex = "";
      if (subindexSelect.value !== "") {
        subindex = parseInt(subindexSelect.value, 16);
      }
      console.log(index, subindex, value);

      if (index === "") {
        alert("error: requires at least the index field to be set")
        return;
      }

      await writeValue(index, subindex, value);
      updateData();
    }

    function updateSubindexSelect() {

      const indexSelect = document.getElementById("indexSelect");
      const subindexSelect = document.getElementById("subindexSelect");
      const index = parseInt(indexSelect.value, 16);
      const obj = objects[index];

      // clear select options
      subindexSelect.options.length = 0

      let opt = document.createElement("option");
      opt.value = "";
      opt.innerHTML = "None";
      subindexSelect.appendChild(opt);

      if (obj.subindexes === undefined) {
        document.getElementById("subindexSelect").disabled = true;
      } else {
        document.getElementById("subindexSelect").disabled = false;
        for (const subindex in objects[index].subindexes) {
          let subindexHex = "0x" + parseInt(subindex).toString(16).toUpperCase();
          let opt = document.createElement("option");
          opt.value = subindexHex;
          opt.innerHTML = `${subindexHex} - ${objects[index].subindexes[subindex].name}`;
          subindexSelect.appendChild(opt);
        }
      }
      updateData();
    }

    let objects;

    async function readAllObjects() {
      objects = await fetch(`http://${window.location.host}/od-all`)
        .then(response => response.json())
        .then(data => {
          if (data.error !== undefined) {
            console.log(data);
          }
          return data;
        });
    }

    async function updateIndexSelect() {

      await readAllObjects();

      const indexSelect = document.getElementById("indexSelect");
      indexSelect.onchange = updateSubindexSelect
      for (const index in objects) {
        let indexHex = "0x" + parseInt(index).toString(16).toUpperCase();
        let opt = document.createElement("option");
        opt.value = indexHex;
        opt.innerHTML = `${indexHex} - ${objects[index].name}`;
        indexSelect.appendChild(opt);
      }

      const subindexSelect = document.getElementById("subindexSelect");
      subindexSelect.onchange = updateData

      updateSubindexSelect();
    }

    updateIndexSelect();
  </script>
{% endblock %}
