{"version":3,"sources":["ThemeProvider.tsx","camera.ts","ImageDataPreview.tsx","component-value.ts","worker/fesion.worker.ts","worker/proxy.ts","MyComponent.tsx","index.tsx"],"names":["ThemeProvider","props","stTheme","useRenderData","theme","muiTheme","createTheme","palette","primary","main","primaryColor","background","default","backgroundColor","paper","secondaryBackgroundColor","text","textColor","typography","fontFamily","font","children","stopStream","stream","getTracks","forEach","track","stop","ImageDataPreview","canvasRef","useRef","imageData","useEffect","current","canvasElem","width","height","Streamlit","setFrameHeight","ctx","getContext","putImageData","ref","setComponentValue","componentValue","Worker_fn","undefined","WorkerProxy","options","worker","workerInitialData","_isLoaded","this","funcName","funcDefPyCode","requirements","Worker","onmessage","e","_processWorkerMessage","data","msg","type","postInitialData","initDataMessage","postMessage","message","expectedReplyType","Promise","resolve","reject","channel","MessageChannel","port1","close","error","Error","port2","_asyncPostMessage","then","console","debug","filterFuncConfig","MyComponent","renderData","imageFilterPyFuncDefCode","args","imageFilterPyFuncName","imageFilterDepPackages","imageFilterDepPackagesJson","JSON","stringify","sort","useState","workerProxy","setWorkerProxy","pythonError","filterDepPackages","parse","updateFuncCode","frame","setFrame","playing","setPlaying","play","useCallback","playingRef","onFrame","a","isLoaded","process","outImageData","stack","startsWith","videoConstraints","onFrameFnRef","unmounted","videoElem","document","createElement","canvasCtx","lastFrameTime","onAnimationFrame","paused","currentTime","drawImage","getImageData","window","requestAnimationFrame","navigator","mediaDevices","getUserMedia","video","audio","_stream","onloadedmetadata","videoWidth","videoHeight","srcObject","pause","remove","useCamera","Box","position","display","top","left","justifyContent","alignItems","CircularProgress","size","Button","variant","onClick","ReactDOM","render","StrictMode","CssBaseline","getElementById"],"mappings":"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","file":"static/js/main.004ad76c.chunk.js","sourcesContent":["import React from \"react\";\nimport {\n  ThemeProvider as MuiThemeProvider,\n  createTheme,\n} from \"@mui/material/styles\";\nimport { useRenderData } from \"streamlit-component-lib-react-hooks\";\n\ninterface ThemeProviderProps {\n  children: React.ReactNode;\n}\nconst ThemeProvider: React.VFC<ThemeProviderProps> = (props) => {\n  const { theme: stTheme } = useRenderData();\n\n  if (stTheme == null) {\n    return <>props.children</>;\n  }\n\n  const muiTheme = createTheme({\n    palette: {\n      primary: {\n        main: stTheme.primaryColor,\n      },\n      background: {\n        default: stTheme.backgroundColor,\n        paper: stTheme.secondaryBackgroundColor,\n      },\n      text: {\n        primary: stTheme.textColor,\n      },\n    },\n    typography: {\n      fontFamily: stTheme.font,\n    },\n  });\n\n  return <MuiThemeProvider theme={muiTheme}>{props.children}</MuiThemeProvider>;\n};\n\nexport default ThemeProvider;\n","import { useEffect, useRef } from \"react\";\n\nfunction stopStream(stream: MediaStream): void {\n  stream.getTracks().forEach((track) => {\n    track.stop();\n  });\n}\n\ntype onFrameFn = (imageData: ImageData) => void | Promise<void>;\n\ninterface UseCameraOptions {\n  playing: boolean;\n  videoConstraints: MediaStreamConstraints[\"video\"];\n  onFrame: onFrameFn;\n}\nexport const useCamera = ({\n  playing,\n  videoConstraints,\n  onFrame,\n}: UseCameraOptions): void => {\n  const onFrameFnRef = useRef<onFrameFn>(onFrame);\n  onFrameFnRef.current = onFrame;\n\n  useEffect(() => {\n    if (!playing) {\n      return;\n    }\n\n    let unmounted = false;\n\n    const videoElem = document.createElement(\"video\");\n\n    const canvasElem = document.createElement(\"canvas\");\n    const canvasCtx = canvasElem.getContext(\"2d\"); // TODO: Check if another context type is better.\n\n    if (canvasCtx == null) {\n      throw new Error(\"Failed to get a canvas context.\");\n    }\n\n    let lastFrameTime: number | undefined = undefined;\n    const onAnimationFrame = async () => {\n      if (unmounted) {\n        return;\n      }\n\n      if (!videoElem.paused && videoElem.currentTime !== lastFrameTime) {\n        lastFrameTime = videoElem.currentTime;\n\n        canvasCtx.drawImage(videoElem, 0, 0);\n        const imageData = canvasCtx.getImageData(\n          0,\n          0,\n          canvasElem.width,\n          canvasElem.height\n        );\n\n        await onFrameFnRef.current(imageData); // NOTE: Wait for the promise resolution here, but parallel execution may also be an option.\n      }\n\n      window.requestAnimationFrame(onAnimationFrame);\n    };\n\n    let stream: MediaStream | null = null;\n    navigator.mediaDevices\n      .getUserMedia({\n        video: videoConstraints,\n        audio: false,\n      })\n      .then((_stream) => {\n        if (unmounted) {\n          stopStream(_stream);\n          return;\n        }\n\n        stream = _stream;\n\n        videoElem.onloadedmetadata = function () {\n          if (unmounted) {\n            return;\n          }\n\n          canvasElem.width = videoElem.videoWidth;\n          canvasElem.height = videoElem.videoHeight;\n          videoElem.play();\n\n          window.requestAnimationFrame(onAnimationFrame);\n        };\n\n        videoElem.srcObject = stream;\n      });\n\n    return () => {\n      unmounted = true;\n\n      videoElem.pause();\n      videoElem.remove();\n\n      canvasElem.remove();\n\n      if (stream) {\n        stopStream(stream);\n      }\n    };\n  }, [playing, videoConstraints]);\n};\n","import React, { useEffect, useRef } from \"react\";\nimport { Streamlit } from \"streamlit-component-lib\";\n\ninterface ImageDataPreviewProps {\n  imageData: ImageData;\n}\nconst ImageDataPreview: React.VFC<ImageDataPreviewProps> = (props) => {\n  const canvasRef = useRef<HTMLCanvasElement | null>(null);\n\n  const imageData = props.imageData;\n\n  // Size adjustment\n  useEffect(() => {\n    if (canvasRef.current == null) {\n      return;\n    }\n\n    const canvasElem = canvasRef.current;\n    canvasElem.width = imageData.width;\n    canvasElem.height = imageData.height;\n\n    Streamlit.setFrameHeight();\n    return () => {\n      Streamlit.setFrameHeight();\n    };\n  }, [imageData.width, imageData.height]);\n\n  // Draw canvas\n  useEffect(() => {\n    if (canvasRef.current == null) {\n      return;\n    }\n\n    const canvasElem = canvasRef.current;\n    const ctx = canvasElem.getContext(\"2d\");\n    ctx?.putImageData(imageData, 0, 0);\n  }, [imageData]);\n\n  return <canvas ref={canvasRef} />;\n};\n\nexport default ImageDataPreview;\n","import { Streamlit } from \"streamlit-component-lib\";\n\nexport interface ComponentValue {\n  pythonError: null | {\n    message: string;\n    stack: string;\n  };\n}\n\nexport function setComponentValue(componentValue: ComponentValue): void {\n  return Streamlit.setComponentValue(componentValue);\n}\n","\nimport worker from \"!!../../node_modules/worker-loader/dist/runtime/inline.js\";\n\nexport default function Worker_fn() {\n  return worker(\"!function(t){var e={};function r(n){if(e[n])return e[n].exports;var o=e[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){\\\"undefined\\\"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:\\\"Module\\\"}),Object.defineProperty(t,\\\"__esModule\\\",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&\\\"object\\\"===typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,\\\"default\\\",{enumerable:!0,value:t}),2&e&&\\\"string\\\"!=typeof t)for(var o in t)r.d(n,o,function(e){return t[e]}.bind(null,o));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,\\\"a\\\",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p=\\\"./\\\",r(r.s=3)}([function(t,e,r){t.exports=r(2)},function(t,e,r){!function(t){\\\"use strict\\\";t.JSONExt=void 0,function(t){function e(t){return null===t||\\\"boolean\\\"===typeof t||\\\"number\\\"===typeof t||\\\"string\\\"===typeof t}function r(t){return Array.isArray(t)}function n(t){return!e(t)&&!r(t)}function o(t,n){if(t===n)return!0;if(e(t)||e(n))return!1;var o=r(t),i=r(n);return o===i&&(o&&i?a(t,n):u(t,n))}function i(t){return e(t)?t:r(t)?c(t):s(t)}function a(t,e){if(t===e)return!0;if(t.length!==e.length)return!1;for(var r=0,n=t.length;r<n;++r)if(!o(t[r],e[r]))return!1;return!0}function u(t,e){if(t===e)return!0;for(var r in t)if(void 0!==t[r]&&!(r in e))return!1;for(var r in e)if(void 0!==e[r]&&!(r in t))return!1;for(var r in t){var n=t[r],i=e[r];if(void 0!==n||void 0!==i){if(void 0===n||void 0===i)return!1;if(!o(n,i))return!1}}return!0}function c(t){for(var e=new Array(t.length),r=0,n=t.length;r<n;++r)e[r]=i(t[r]);return e}function s(t){var e={};for(var r in t){var n=t[r];void 0!==n&&(e[r]=i(n))}return e}t.emptyObject=Object.freeze({}),t.emptyArray=Object.freeze([]),t.isPrimitive=e,t.isArray=r,t.isObject=n,t.deepEqual=o,t.deepCopy=i}(t.JSONExt||(t.JSONExt={}));var e=function(){function t(){this._types=[],this._values=[]}return t.prototype.types=function(){return this._types.slice()},t.prototype.hasData=function(t){return-1!==this._types.indexOf(t)},t.prototype.getData=function(t){var e=this._types.indexOf(t);return-1!==e?this._values[e]:void 0},t.prototype.setData=function(t,e){this.clearData(t),this._types.push(t),this._values.push(e)},t.prototype.clearData=function(t){var e=this._types.indexOf(t);-1!==e&&(this._types.splice(e,1),this._values.splice(e,1))},t.prototype.clear=function(){this._types.length=0,this._values.length=0},t}(),r=function(){function t(){var t=this;this.promise=new Promise((function(e,r){t._resolve=e,t._reject=r}))}return t.prototype.resolve=function(t){(0,this._resolve)(t)},t.prototype.reject=function(t){(0,this._reject)(t)},t}(),n=function(){function t(t){this.name=t,this._tokenStructuralPropertyT=null}return t}();function o(t){for(var e=0,r=0,n=t.length;r<n;++r)r%4===0&&(e=4294967295*Math.random()>>>0),t[r]=255&e,e>>>=8}function i(t){for(var e=new Uint8Array(16),r=new Array(256),n=0;n<16;++n)r[n]=\\\"0\\\"+n.toString(16);for(n=16;n<256;++n)r[n]=n.toString(16);return function(){return t(e),e[6]=64|15&e[6],e[8]=128|63&e[8],r[e[0]]+r[e[1]]+r[e[2]]+r[e[3]]+\\\"-\\\"+r[e[4]]+r[e[5]]+\\\"-\\\"+r[e[6]]+r[e[7]]+\\\"-\\\"+r[e[8]]+r[e[9]]+\\\"-\\\"+r[e[10]]+r[e[11]]+r[e[12]]+r[e[13]]+r[e[14]]+r[e[15]]}}t.Random=void 0,(t.Random||(t.Random={})).getRandomValues=function(){var t=\\\"undefined\\\"!==typeof window&&(window.crypto||window.msCrypto)||null;return t&&\\\"function\\\"===typeof t.getRandomValues?function(e){return t.getRandomValues(e)}:o}(),t.UUID=void 0,(t.UUID||(t.UUID={})).uuid4=i(t.Random.getRandomValues),t.MimeData=e,t.PromiseDelegate=r,t.Token=n,Object.defineProperty(t,\\\"__esModule\\\",{value:!0})}(e)},function(t,e,r){var n=function(t){\\\"use strict\\\";var e,r=Object.prototype,n=r.hasOwnProperty,o=\\\"function\\\"===typeof Symbol?Symbol:{},i=o.iterator||\\\"@@iterator\\\",a=o.asyncIterator||\\\"@@asyncIterator\\\",u=o.toStringTag||\\\"@@toStringTag\\\";function c(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{c({},\\\"\\\")}catch(S){c=function(t,e,r){return t[e]=r}}function s(t,e,r,n){var o=e&&e.prototype instanceof g?e:g,i=Object.create(o.prototype),a=new k(n||[]);return i._invoke=function(t,e,r){var n=l;return function(o,i){if(n===h)throw new Error(\\\"Generator is already running\\\");if(n===y){if(\\\"throw\\\"===o)throw i;return D()}for(r.method=o,r.arg=i;;){var a=r.delegate;if(a){var u=j(a,r);if(u){if(u===d)continue;return u}}if(\\\"next\\\"===r.method)r.sent=r._sent=r.arg;else if(\\\"throw\\\"===r.method){if(n===l)throw n=y,r.arg;r.dispatchException(r.arg)}else\\\"return\\\"===r.method&&r.abrupt(\\\"return\\\",r.arg);n=h;var c=f(t,e,r);if(\\\"normal\\\"===c.type){if(n=r.done?y:p,c.arg===d)continue;return{value:c.arg,done:r.done}}\\\"throw\\\"===c.type&&(n=y,r.method=\\\"throw\\\",r.arg=c.arg)}}}(t,r,a),i}function f(t,e,r){try{return{type:\\\"normal\\\",arg:t.call(e,r)}}catch(S){return{type:\\\"throw\\\",arg:S}}}t.wrap=s;var l=\\\"suspendedStart\\\",p=\\\"suspendedYield\\\",h=\\\"executing\\\",y=\\\"completed\\\",d={};function g(){}function v(){}function m(){}var w={};c(w,i,(function(){return this}));var _=Object.getPrototypeOf,b=_&&_(_(I([])));b&&b!==r&&n.call(b,i)&&(w=b);var x=m.prototype=g.prototype=Object.create(w);function P(t){[\\\"next\\\",\\\"throw\\\",\\\"return\\\"].forEach((function(e){c(t,e,(function(t){return this._invoke(e,t)}))}))}function O(t,e){function r(o,i,a,u){var c=f(t[o],t,i);if(\\\"throw\\\"!==c.type){var s=c.arg,l=s.value;return l&&\\\"object\\\"===typeof l&&n.call(l,\\\"__await\\\")?e.resolve(l.__await).then((function(t){r(\\\"next\\\",t,a,u)}),(function(t){r(\\\"throw\\\",t,a,u)})):e.resolve(l).then((function(t){s.value=t,a(s)}),(function(t){return r(\\\"throw\\\",t,a,u)}))}u(c.arg)}var o;this._invoke=function(t,n){function i(){return new e((function(e,o){r(t,n,e,o)}))}return o=o?o.then(i,i):i()}}function j(t,r){var n=t.iterator[r.method];if(n===e){if(r.delegate=null,\\\"throw\\\"===r.method){if(t.iterator.return&&(r.method=\\\"return\\\",r.arg=e,j(t,r),\\\"throw\\\"===r.method))return d;r.method=\\\"throw\\\",r.arg=new TypeError(\\\"The iterator does not provide a 'throw' method\\\")}return d}var o=f(n,t.iterator,r.arg);if(\\\"throw\\\"===o.type)return r.method=\\\"throw\\\",r.arg=o.arg,r.delegate=null,d;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,\\\"return\\\"!==r.method&&(r.method=\\\"next\\\",r.arg=e),r.delegate=null,d):i:(r.method=\\\"throw\\\",r.arg=new TypeError(\\\"iterator result is not an object\\\"),r.delegate=null,d)}function L(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function E(t){var e=t.completion||{};e.type=\\\"normal\\\",delete e.arg,t.completion=e}function k(t){this.tryEntries=[{tryLoc:\\\"root\\\"}],t.forEach(L,this),this.reset(!0)}function I(t){if(t){var r=t[i];if(r)return r.call(t);if(\\\"function\\\"===typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function r(){for(;++o<t.length;)if(n.call(t,o))return r.value=t[o],r.done=!1,r;return r.value=e,r.done=!0,r};return a.next=a}}return{next:D}}function D(){return{value:e,done:!0}}return v.prototype=m,c(x,\\\"constructor\\\",m),c(m,\\\"constructor\\\",v),v.displayName=c(m,u,\\\"GeneratorFunction\\\"),t.isGeneratorFunction=function(t){var e=\\\"function\\\"===typeof t&&t.constructor;return!!e&&(e===v||\\\"GeneratorFunction\\\"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,m):(t.__proto__=m,c(t,u,\\\"GeneratorFunction\\\")),t.prototype=Object.create(x),t},t.awrap=function(t){return{__await:t}},P(O.prototype),c(O.prototype,a,(function(){return this})),t.AsyncIterator=O,t.async=function(e,r,n,o,i){void 0===i&&(i=Promise);var a=new O(s(e,r,n,o),i);return t.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},P(x),c(x,u,\\\"Generator\\\"),c(x,i,(function(){return this})),c(x,\\\"toString\\\",(function(){return\\\"[object Generator]\\\"})),t.keys=function(t){var e=[];for(var r in t)e.push(r);return e.reverse(),function r(){for(;e.length;){var n=e.pop();if(n in t)return r.value=n,r.done=!1,r}return r.done=!0,r}},t.values=I,k.prototype={constructor:k,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method=\\\"next\\\",this.arg=e,this.tryEntries.forEach(E),!t)for(var r in this)\\\"t\\\"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if(\\\"throw\\\"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function o(n,o){return u.type=\\\"throw\\\",u.arg=t,r.next=n,o&&(r.method=\\\"next\\\",r.arg=e),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],u=a.completion;if(\\\"root\\\"===a.tryLoc)return o(\\\"end\\\");if(a.tryLoc<=this.prev){var c=n.call(a,\\\"catchLoc\\\"),s=n.call(a,\\\"finallyLoc\\\");if(c&&s){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!s)throw new Error(\\\"try statement without catch or finally\\\");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,\\\"finallyLoc\\\")&&this.prev<o.finallyLoc){var i=o;break}}i&&(\\\"break\\\"===t||\\\"continue\\\"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method=\\\"next\\\",this.next=i.finallyLoc,d):this.complete(a)},complete:function(t,e){if(\\\"throw\\\"===t.type)throw t.arg;return\\\"break\\\"===t.type||\\\"continue\\\"===t.type?this.next=t.arg:\\\"return\\\"===t.type?(this.rval=this.arg=t.arg,this.method=\\\"return\\\",this.next=\\\"end\\\"):\\\"normal\\\"===t.type&&e&&(this.next=e),d},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),E(r),d}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if(\\\"throw\\\"===n.type){var o=n.arg;E(r)}return o}}throw new Error(\\\"illegal catch attempt\\\")},delegateYield:function(t,r,n){return this.delegate={iterator:I(t),resultName:r,nextLoc:n},\\\"next\\\"===this.method&&(this.arg=e),d}},t}(t.exports);try{regeneratorRuntime=n}catch(o){\\\"object\\\"===typeof globalThis?globalThis.regeneratorRuntime=n:Function(\\\"r\\\",\\\"regeneratorRuntime = r\\\")(n)}},function(t,e,r){\\\"use strict\\\";r.r(e);var n=r(0),o=r.n(n);function i(t,e,r,n,o,i,a){try{var u=t[i](a),c=u.value}catch(s){return void r(s)}u.done?e(c):Promise.resolve(c).then(n,o)}function a(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var a=t.apply(e,r);function u(t){i(a,n,o,u,c,\\\"next\\\",t)}function c(t){i(a,n,o,u,c,\\\"throw\\\",t)}u(void 0)}))}}var u=r(1),c=(e.default={},self);importScripts(\\\"https://cdn.jsdelivr.net/pyodide/v0.21.3/full/pyodide.js\\\");var s,f,l=\\\"gai6sa2eM9Atiev5Shu5ohtie6phai8i\\\",p=new u.PromiseDelegate;function h(){return(h=a(o.a.mark((function t(){var e,r,n,i;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,p.promise;case 2:return e=t.sent,r=e.funcName,n=e.funcDefPyCode,i=e.requirements,t.next=8,loadPyodide();case 8:return s=t.sent,t.next=11,s.loadPackage([\\\"numpy\\\"]).then((function(){return s.runPythonAsync(\\\"import numpy as \\\".concat(l))}));case 11:return t.next=13,s.loadPackagesFromImports(n);case 13:return t.next=15,s.loadPackage(i);case 15:return t.next=17,s.runPythonAsync(n);case 17:return f=r,t.next=20,s.runPythonAsync(\\\"\\\\nimport asyncio\\\\n\\\");case 20:c.postMessage({type:\\\"loaded\\\"}),console.log(\\\"Worker initialization finished.\\\");case 22:case\\\"end\\\":return t.stop()}}),t)})))).apply(this,arguments)}var y=function(){return h.apply(this,arguments)}();function d(t){return g.apply(this,arguments)}function g(){return(g=a(o.a.mark((function t(e){var r,n,i,a,u;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return self.fesionImageWidth=e.width,self.fesionImageHeight=e.height,self.fesionImageData=e.data,t.next=5,s.runPythonAsync(\\\"\\\\n  from js import fesionImageWidth, fesionImageHeight, fesionImageData  # Import from JS globals\\\\n\\\\n  input_image4chan = \\\".concat(l,\\\".asarray(fesionImageData.to_py()).reshape((fesionImageHeight, fesionImageWidth, 4)) # 4 channels (RGBA)\\\\n  input_image = input_image4chan[:,:,:3]\\\\n\\\\n  if asyncio.iscoroutinefunction(\\\").concat(f,\\\"):\\\\n      output_image = await \\\").concat(f,\\\"(input_image)\\\\n  else:\\\\n      output_image = \\\").concat(f,\\\"(input_image)\\\\n\\\\n  if \\\").concat(l,\\\".issubdtype(output_image.dtype, \\\").concat(l,\\\".floating):\\\\n      output_image = (output_image * 255).astype(\\\").concat(l,\\\".uint8)\\\\n\\\\n  output_alpha = \\\").concat(l,\\\".full((fesionImageHeight, fesionImageWidth, 1), fill_value=255, dtype=\\\").concat(l,\\\".uint8)\\\\n  output_image4chan = \\\").concat(l,\\\".concatenate((output_image, output_alpha), axis=2).copy()\\\\n\\\\n  output_height, output_width = output_image4chan.shape[:2]\\\\n  \\\"));case 5:return r=s.globals.get(\\\"output_image4chan\\\"),n=r.getBuffer(\\\"u8\\\"),r.destroy(),i=s.globals.get(\\\"output_width\\\"),a=s.globals.get(\\\"output_height\\\"),t.prev=10,u=new ImageData(new Uint8ClampedArray(n.data.buffer,n.data.byteOffset,n.data.byteLength),i,a),t.abrupt(\\\"return\\\",u);case 13:return t.prev=13,n.release(),t.finish(13);case 16:case\\\"end\\\":return t.stop()}}),t,null,[[10,,13,16]])})))).apply(this,arguments)}self.onmessage=function(){var t=a(o.a.mark((function t(e){var r,n,i,a,u,c,l,h,g;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(\\\"initData\\\"!==(r=e.data).type){t.next=4;break}return p.resolve(r.data),t.abrupt(\\\"return\\\");case 4:return t.next=6,y;case 6:n=e.ports[0],i=function(t){return n.postMessage(t)},t.prev=8,t.t0=r.type,t.next=\\\"inputImage\\\"===t.t0?12:\\\"updateFilterFunc\\\"===t.t0?18:31;break;case 12:return a=r.data.imageData,t.next=15,d(a);case 15:return u=t.sent,i({type:\\\"outputImage\\\",data:{imageData:u}}),t.abrupt(\\\"break\\\",31);case 18:return c=r.data,l=c.funcName,h=c.funcDefPyCode,g=c.requirements,console.debug(\\\"updateFilterFunc\\\",{funcName:l,funcDefPyCode:h,requirements:g}),t.next=22,s.loadPackagesFromImports(h);case 22:return t.next=24,s.loadPackage(g);case 24:return t.next=26,s.runPythonAsync(\\\"\\\\n          try:\\\\n              del \\\".concat(f,\\\"\\\\n          except NameError:\\\\n              pass\\\\n        \\\"));case 26:return t.next=28,s.runPythonAsync(h);case 28:return f=l,i({type:\\\"reply\\\"}),t.abrupt(\\\"break\\\",31);case 31:t.next=36;break;case 33:t.prev=33,t.t1=t.catch(8),i({type:\\\"reply\\\",error:t.t1});case 36:case\\\"end\\\":return t.stop()}}),t,null,[[8,33]])})));return function(e){return t.apply(this,arguments)}}(),c.postMessage({type:\\\"ready\\\"})}]);\\n\", \"Worker\", undefined, undefined);\n}\n","import Worker from \"./fesion.worker\";\n\ninterface WorkerProxyOptions {\n  funcName: string;\n  funcDefPyCode: string;\n  requirements: string[];\n}\n\nexport class WorkerProxy {\n  private worker: Worker;\n  private workerInitialData: FilterFuncConfig;\n\n  private _isLoaded: boolean;\n  public get isLoaded(): boolean {\n    return this._isLoaded;\n  }\n\n  public constructor(options: WorkerProxyOptions) {\n    this.workerInitialData = {\n      funcName: options.funcName,\n      funcDefPyCode: options.funcDefPyCode,\n      requirements: options.requirements,\n    };\n    this._isLoaded = false;\n\n    this.worker = new Worker();\n    this.worker.onmessage = (e) => {\n      this._processWorkerMessage(e.data);\n    };\n  }\n\n  private _processWorkerMessage(msg: OutMessage): void {\n    switch (msg.type) {\n      case \"ready\": {\n        this.postInitialData();\n        break;\n      }\n      case \"loaded\": {\n        this._isLoaded = true;\n      }\n    }\n  }\n\n  private postInitialData() {\n    const initDataMessage: InitDataMessage = {\n      type: \"initData\",\n      data: this.workerInitialData,\n    };\n    this.worker.postMessage(initDataMessage);\n  }\n\n  private _asyncPostMessage(\n    message: InMessage\n  ): Promise<GeneralReplyMessage[\"data\"]>;\n  private _asyncPostMessage<T extends ReplyMessage[\"type\"]>(\n    message: InMessage,\n    expectedReplyType: T\n  ): Promise<Extract<ReplyMessage, { type: T }>[\"data\"]>;\n  private _asyncPostMessage(\n    message: InMessage,\n    expectedReplyType = \"reply\"\n  ): Promise<ReplyMessage[\"data\"]> {\n    return new Promise((resolve, reject) => {\n      const channel = new MessageChannel();\n\n      channel.port1.onmessage = (e: MessageEvent<ReplyMessage>) => {\n        channel.port1.close();\n        const msg = e.data;\n        if (msg.error) {\n          reject(msg.error);\n        } else {\n          if (msg.type !== expectedReplyType) {\n            throw new Error(`Unexpected reply type \"${msg.type}\"`);\n          }\n          resolve(msg.data);\n        }\n      };\n\n      this.worker.postMessage(message, [channel.port2]);\n    });\n  }\n\n  public process(imageData: ImageData): Promise<ImageData> {\n    if (!this._isLoaded) {\n      console.debug(\"Worker is not loaded\");\n      return Promise.resolve(imageData);\n    }\n\n    return this._asyncPostMessage(\n      {\n        type: \"inputImage\",\n        data: {\n          imageData,\n        },\n      },\n      \"outputImage\"\n    ).then((data) => {\n      return data.imageData;\n    });\n  }\n\n  public updateFuncCode(filterFuncConfig: FilterFuncConfig): Promise<void> {\n    return this._asyncPostMessage({\n      type: \"updateFilterFunc\",\n      data: filterFuncConfig,\n    });\n  }\n}\n","import React, { useState, useCallback, useEffect, useRef } from \"react\";\nimport { useRenderData } from \"streamlit-component-lib-react-hooks\";\nimport Button from \"@mui/material/Button\";\nimport CircularProgress from \"@mui/material/CircularProgress\";\nimport Box from \"@mui/material/Box\";\nimport { useCamera } from \"./camera\";\nimport ImageDataPreview from \"./ImageDataPreview\";\nimport { setComponentValue } from \"./component-value\";\nimport { WorkerProxy } from \"./worker/proxy\";\n\nconst MyComponent: React.VFC = () => {\n  const renderData = useRenderData();\n\n  const imageFilterPyFuncDefCode = renderData.args[\"func_def_code\"];\n  const imageFilterPyFuncName = renderData.args[\"func_name\"]; // TODO: Create a denied name list as a func_name, which are already used as global entity names, like `fesionImageWidth`.\n  const imageFilterDepPackages: string[] =\n    renderData.args[\"dep_packages\"] ?? [];\n  const imageFilterDepPackagesJson = JSON.stringify(\n    imageFilterDepPackages.sort()\n  ); // Serialize for memoization\n\n  const [workerProxy, setWorkerProxy] = useState<WorkerProxy>();\n  useEffect(\n    () => {\n      setComponentValue({ pythonError: null });\n\n      const filterDepPackages: string[] = JSON.parse(\n        imageFilterDepPackagesJson\n      );\n\n      const workerProxy = new WorkerProxy({\n        funcName: imageFilterPyFuncName,\n        funcDefPyCode: imageFilterPyFuncDefCode,\n        requirements: filterDepPackages,\n      });\n\n      setWorkerProxy(workerProxy);\n    },\n    [\n      // No deps because workerProxy should not be re-created.\n    ]\n  );\n  useEffect(() => {\n    if (workerProxy == null) {\n      return;\n    }\n\n    setComponentValue({ pythonError: null });\n\n    const filterDepPackages: string[] =\n      JSON.parse(imageFilterDepPackagesJson) || [];\n\n    workerProxy.updateFuncCode({\n      funcName: imageFilterPyFuncName,\n      funcDefPyCode: imageFilterPyFuncDefCode,\n      requirements: filterDepPackages,\n    });\n  }, [\n    // `workerProxy` is excluded from the deps so that this function is not called just reacting the initialization of `workerProxy`.\n    imageFilterPyFuncName,\n    imageFilterPyFuncDefCode,\n    imageFilterDepPackagesJson,\n  ]);\n\n  const [frame, setFrame] = useState<ImageData>();\n\n  const [playing, setPlaying] = useState(false);\n\n  const play = useCallback(() => setPlaying(true), []);\n  const stop = useCallback(() => {\n    setPlaying(false);\n    setFrame(undefined);\n  }, []);\n\n  const playingRef = useRef(false);\n  playingRef.current = playing;\n  const onFrame = useCallback(\n    async (imageData: ImageData) => {\n      if (workerProxy == null || !workerProxy.isLoaded) {\n        setFrame(imageData);\n        return;\n      }\n\n      try {\n        const outImageData = await workerProxy.process(imageData);\n        // Here is called asynchronously, so use ref to check the `playing` value.\n        if (!playingRef.current) {\n          setFrame(undefined);\n          return;\n        }\n        setFrame(outImageData);\n\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      } catch (err: any) {\n        if (\n          typeof err.stack === \"string\" &&\n          err.stack.startsWith(\"PythonError\")\n        ) {\n          const serializableError = {\n            stack: err.stack,\n            message: err.message,\n          };\n          setComponentValue({ pythonError: serializableError });\n        }\n        setPlaying(false);\n        throw err;\n      }\n    },\n    [workerProxy]\n  );\n\n  useCamera({\n    playing,\n    videoConstraints: true,\n    onFrame,\n  });\n\n  return (\n    <Box>\n      <Box position=\"relative\" display=\"inline-block\">\n        {playing && (workerProxy == null || !workerProxy.isLoaded) && (\n          <Box\n            position=\"absolute\"\n            top={0}\n            left={0}\n            width=\"100%\"\n            height=\"100%\"\n            display=\"flex\"\n            justifyContent=\"center\"\n            alignItems=\"center\"\n          >\n            <CircularProgress size={80} />\n          </Box>\n        )}\n        <Box>{frame && <ImageDataPreview imageData={frame} />}</Box>\n      </Box>\n      <Box>\n        {playing ? (\n          <Button variant=\"contained\" onClick={stop}>\n            Stop\n          </Button>\n        ) : (\n          <Button variant=\"contained\" onClick={play}>\n            Play\n          </Button>\n        )}\n      </Box>\n    </Box>\n  );\n};\n\nexport default MyComponent;\n","import React from \"react\";\nimport ReactDOM from \"react-dom\";\nimport CssBaseline from \"@mui/material/CssBaseline\";\nimport ThemeProvider from \"./ThemeProvider\";\nimport { StreamlitProvider } from \"streamlit-component-lib-react-hooks\";\nimport MyComponent from \"./MyComponent\";\n\nReactDOM.render(\n  <React.StrictMode>\n    <CssBaseline />\n    <StreamlitProvider>\n      <ThemeProvider>\n        <MyComponent />\n      </ThemeProvider>\n    </StreamlitProvider>\n  </React.StrictMode>,\n  document.getElementById(\"root\")\n);\n"],"sourceRoot":""}